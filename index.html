<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>大竹中学高2022级六班</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            neutral: {
              100: '#F5F5F5',
              200: '#E5E5E5',
              300: '#D4D4D4',
              400: '#A3A3A3',
              500: '#737373',
              600: '#525252',
              700: '#404040',
              800: '#262626',
              900: '#171717',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .btn-hover {
        @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
      }
      .form-input {
        @apply w-full px-4 py-2.5 rounded-lg border border-neutral-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all duration-200;
      }
      .page-transition {
        @apply transition-opacity duration-300;
      }
      .bg-blur {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .notification-dot {
        @apply absolute -top-1 -right-1 w-4 h-4 bg-danger rounded-full text-white text-[10px] flex items-center justify-center;
      }
    }
  </style>
</head>

<body class="font-inter bg-neutral-100 text-neutral-800 min-h-screen flex flex-col">
  <!-- 页面容器 -->
  <div id="app" class="flex-1">
    <!-- 登录页面 -->
    <div id="login-page" class="page-transition min-h-screen flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-white rounded-2xl p-6 md:p-8 card-shadow flex flex-col items-center">
        <!-- 已移除登录界面图片 -->
        
        <div class="text-center mb-8 w-full">
          <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-neutral-800 mb-2">大竹中学高2022级六班</h1>
          <p class="text-neutral-500">请登录您的账号</p>
        </div>
        
        <form id="login-form" class="space-y-5 w-full">
          <div>
            <label for="username" class="block text-sm font-medium text-neutral-700 mb-1">账号</label>
            <input type="text" id="username" class="form-input" placeholder="输入账号" required>
          </div>
          
          <div>
            <label for="password" class="block text-sm font-medium text-neutral-700 mb-1">密码</label>
            <input type="password" id="password" class="form-input" placeholder="输入密码" required>
          </div>
          
          <div class="flex items-center justify-between">
            <label class="flex items-center">
              <input type="checkbox" class="rounded text-primary focus:ring-primary h-4 w-4">
              <span class="ml-2 text-sm text-neutral-600">记住我</span>
            </label>
            <a href="#" id="show-register" class="text-sm text-primary hover:underline">注册次账号</a>
          </div>
          
          <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-medium btn-hover">
            登录
          </button>
        </form>
      </div>
    </div>
    
    <!-- 注册页面 -->
    <div id="register-page" class="page-transition min-h-screen flex items-center justify-center p-4 hidden">
      <div class="w-full max-w-md bg-white rounded-2xl p-6 md:p-8 card-shadow">
        <div class="text-center mb-6">
          <h1 class="text-xl font-bold text-neutral-800 mb-2">注册次账号</h1>
          <p class="text-neutral-500 text-sm">账号将自动分配，密码由您设置</p>
        </div>
        
        <form id="register-form" class="space-y-5">
          <div>
            <label for="reg-password" class="block text-sm font-medium text-neutral-700 mb-1">设置密码</label>
            <input type="password" id="reg-password" class="form-input" placeholder="设置密码" required>
          </div>
          
          <div>
            <label for="reg-confirm" class="block text-sm font-medium text-neutral-700 mb-1">确认密码</label>
            <input type="password" id="reg-confirm" class="form-input" placeholder="再次输入密码" required>
          </div>
          
          <div class="text-xs text-neutral-500 p-3 bg-neutral-100 rounded-lg">
            <p>注册成功后，系统将自动为您分配一个账号（1-10000之间未使用的号码）。</p>
          </div>
          
          <div class="flex gap-3">
            <button type="button" id="back-to-login" class="flex-1 bg-neutral-200 text-neutral-700 py-3 rounded-lg font-medium btn-hover">
              返回登录
            </button>
            <button type="submit" class="flex-1 bg-primary text-white py-3 rounded-lg font-medium btn-hover">
              注册
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- 主账号控制面板 - 已移除背景壁纸 -->
    <div id="main-account-page" class="page-transition hidden bg-white">
      <!-- 顶部导航 -->
      <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
          <div class="flex items-center">
            <i class="fa fa-dashboard text-primary text-xl mr-2"></i>
            <h1 class="text-lg font-semibold">主账号控制面板</h1>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm text-neutral-600 hidden md:inline">chenkai_wangzhan</span>
            <div class="relative">
              <button id="notification-btn" class="text-neutral-500 hover:text-primary transition-colors p-2">
                <i class="fa fa-bell"></i>
                <span id="notification-dot" class="notification-dot hidden">0</span>
              </button>
            </div>
            <button id="main-logout" class="text-neutral-500 hover:text-danger transition-colors p-2">
              <i class="fa fa-sign-out"></i>
            </button>
          </div>
        </div>
      </header>
      
      <!-- 通知面板 -->
      <div id="notification-panel" class="fixed top-16 right-4 w-72 bg-white rounded-xl shadow-lg z-20 hidden max-h-96 overflow-y-auto">
        <div class="p-3 border-b border-neutral-200">
          <h3 class="font-medium">通知</h3>
        </div>
        <div id="notification-list" class="p-2">
          <div class="text-center text-neutral-400 py-4 text-sm">
            暂无通知
          </div>
        </div>
      </div>
      
      <!-- 主要内容 -->
      <main class="container mx-auto px-4 py-6">
        <!-- 内容背景层 -->
        <div class="bg-white rounded-3xl p-6 md:p-8 mb-6 card-shadow">
          <!-- 发布文章按钮 - 主账号专用 -->
          <div class="mb-6 text-right">
            <button id="main-new-article-btn" class="bg-primary text-white px-6 py-2.5 rounded-lg font-medium btn-hover inline-flex items-center">
              <i class="fa fa-plus mr-2"></i> 发布文章
            </button>
          </div>
          
          <!-- 统计卡片 -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl p-5 card-shadow">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-neutral-500 text-sm mb-1">已注册次账号</p>
                  <h3 class="text-2xl font-bold text-neutral-800" id="registered-count">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                  <i class="fa fa-users"></i>
                </div>
              </div>
              <div class="mt-3 text-xs text-success flex items-center">
                <i class="fa fa-arrow-up mr-1"></i>
                <span>今日新增 0 个</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-5 card-shadow">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-neutral-500 text-sm mb-1">待审核文章</p>
                  <h3 class="text-2xl font-bold text-neutral-800" id="pending-count">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                  <i class="fa fa-file-text-o"></i>
                </div>
              </div>
              <div class="mt-3 text-xs text-neutral-500 flex items-center">
                <span>需及时处理</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-5 card-shadow">
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-neutral-500 text-sm mb-1">已发布文章</p>
                  <h3 class="text-2xl font-bold text-neutral-800" id="published-count">0</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center text-success">
                  <i class="fa fa-check-circle-o"></i>
                </div>
              </div>
              <div class="mt-3 text-xs text-success flex items-center">
                <i class="fa fa-arrow-up mr-1"></i>
                <span>本月增长 0%</span>
              </div>
            </div>
          </div>
          
          <!-- 图表 -->
          <div class="bg-white rounded-xl p-5 card-shadow mb-6">
            <h3 class="font-medium text-neutral-800 mb-4">文章发布统计</h3>
            <div class="h-64">
              <canvas id="stats-chart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- 次账号列表 -->
        <div class="bg-white rounded-3xl p-6 md:p-8 mb-6 card-shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-medium text-neutral-800">次账号列表</h3>
            <div class="relative">
              <input type="text" placeholder="搜索账号..." class="form-input pl-10 py-2 w-full md:w-64">
              <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-neutral-200">
                  <th class="py-3 text-left text-neutral-500 font-medium">账号ID</th>
                  <th class="py-3 text-left text-neutral-500 font-medium">注册时间</th>
                  <th class="py-3 text-left text-neutral-500 font-medium">发布文章数</th>
                  <th class="py-3 text-left text-neutral-500 font-medium">状态</th>
                  <th class="py-3 text-left text-neutral-500 font-medium">操作</th>
                </tr>
              </thead>
              <tbody id="subaccounts-table">
                <tr>
                  <td colspan="5" class="py-8 text-center text-neutral-400">
                    暂无注册的次账号
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- 待审核文章 -->
        <div class="bg-white rounded-3xl p-6 md:p-8 mb-6 card-shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-medium text-neutral-800">待审核文章</h3>
            <span class="bg-warning/10 text-warning text-xs px-2 py-1 rounded-full">
              <span id="pending-badge">0</span> 篇待审核
            </span>
          </div>
          
          <div id="pending-articles" class="space-y-4">
            <div class="text-center text-neutral-400 py-8">
              暂无待审核文章
            </div>
          </div>
        </div>
        
        <!-- 所有已发布文章 -->
        <div class="bg-white rounded-3xl p-6 md:p-8 card-shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-medium text-neutral-800">所有已发布文章</h3>
            <span class="bg-success/10 text-success text-xs px-2 py-1 rounded-full">
              <span id="published-badge">0</span> 篇已发布
            </span>
          </div>
          
          <div id="all-published-articles" class="space-y-4">
            <div class="text-center text-neutral-400 py-8">
              暂无已发布文章
            </div>
          </div>
        </div>
      </main>
    </div>
    
    <!-- 次账号页面 - 已移除背景壁纸 -->
    <div id="sub-account-page" class="page-transition hidden bg-white">
      <!-- 顶部导航 -->
      <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
          <div class="flex items-center">
            <i class="fa fa-pencil text-primary text-xl mr-2"></i>
            <h1 class="text-lg font-semibold">大竹中学高2022级六班</h1>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm text-neutral-600 hidden md:inline" id="sub-account-id">账号: --</span>
            <button id="sub-logout" class="text-neutral-500 hover:text-danger transition-colors p-2">
              <i class="fa fa-sign-out"></i>
            </button>
          </div>
        </div>
      </header>
      
      <!-- 主要内容 -->
      <main class="container mx-auto px-4 py-6">
        <!-- 发布文章按钮 -->
        <div class="mb-6 text-center">
          <button id="new-article-btn" class="bg-primary text-white px-6 py-3 rounded-lg font-medium btn-hover inline-flex items-center">
            <i class="fa fa-plus mr-2"></i> 发布新文章
          </button>
        </div>
        
        <!-- 我的文章列表 -->
        <div class="bg-white rounded-3xl p-6 md:p-8 mb-6 card-shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-medium text-neutral-800">我的文章</h3>
            <div class="flex gap-2">
              <button class="article-filter-btn active bg-primary text-white text-xs px-3 py-1 rounded-full">全部</button>
              <button class="article-filter-btn bg-neutral-200 text-neutral-700 text-xs px-3 py-1 rounded-full">待审核</button>
              <button class="article-filter-btn bg-neutral-200 text-neutral-700 text-xs px-3 py-1 rounded-full">已发布</button>
              <button class="article-filter-btn bg-neutral-200 text-neutral-700 text-xs px-3 py-1 rounded-full">已驳回</button>
            </div>
          </div>
          
          <div id="my-articles" class="space-y-4">
            <div class="text-center text-neutral-400 py-8">
              您尚未发布任何文章
            </div>
          </div>
        </div>
        
        <!-- 所有已发布文章 -->
        <div class="bg-white rounded-3xl p-6 md:p-8 card-shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-medium text-neutral-800">班级已发布文章</h3>
            <span class="bg-success/10 text-success text-xs px-2 py-1 rounded-full">
              <span id="sub-published-badge">0</span> 篇已发布
            </span>
          </div>
          
          <div id="sub-published-articles" class="space-y-4">
            <div class="text-center text-neutral-400 py-8">
              暂无已发布文章
            </div>
          </div>
        </div>
      </main>
    </div>
    
    <!-- 发布文章弹窗 -->
    <div id="article-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-5 border-b border-neutral-200 flex justify-between items-center sticky top-0 bg-white z-10">
          <h2 class="text-lg font-semibold" id="modal-title">发布文章</h2>
          <button id="close-modal" class="text-neutral-500 hover:text-neutral-800 p-2">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="article-form" class="p-5 space-y-5">
          <div>
            <label for="article-title" class="block text-sm font-medium text-neutral-700 mb-1">文章标题 <span class="text-danger">*</span></label>
            <input type="text" id="article-title" class="form-input" placeholder="请输入文章标题" required>
          </div>
          
          <div>
            <label for="article-time" class="block text-sm font-medium text-neutral-700 mb-1">发布时间 <span class="text-danger">*</span></label>
            <input type="datetime-local" id="article-time" class="form-input" required>
          </div>
          
          <div>
            <label for="article-content" class="block text-sm font-medium text-neutral-700 mb-1">文章内容 <span class="text-danger">*</span></label>
            <textarea id="article-content" rows="6" class="form-input" placeholder="请输入文章内容" required></textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-1">上传图片</label>
            <div class="border-2 border-dashed border-neutral-300 rounded-lg p-4 text-center hover:border-primary transition-colors cursor-pointer">
              <input type="file" id="image-upload" class="hidden" accept="image/*" multiple>
              <label for="image-upload" class="cursor-pointer">
                <i class="fa fa-image text-2xl text-neutral-400 mb-2"></i>
                <p class="text-sm text-neutral-500">点击或拖拽图片到此处上传</p>
                <p class="text-xs text-neutral-400 mt-1">支持JPG、PNG格式，最多5张</p>
              </label>
            </div>
            <div id="image-preview" class="mt-3 flex flex-wrap gap-2"></div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-1">上传视频</label>
            <div class="border-2 border-dashed border-neutral-300 rounded-lg p-4 text-center hover:border-primary transition-colors cursor-pointer">
              <input type="file" id="video-upload" class="hidden" accept="video/*">
              <label for="video-upload" class="cursor-pointer">
                <i class="fa fa-film text-2xl text-neutral-400 mb-2"></i>
                <p class="text-sm text-neutral-500">点击上传视频</p>
                <p class="text-xs text-neutral-400 mt-1">支持MP4格式，单个文件不超过100MB</p>
              </label>
            </div>
            <div id="video-preview" class="mt-3 hidden">
              <video id="preview-video" controls class="max-w-full rounded-lg"></video>
              <button type="button" id="remove-video" class="mt-1 text-xs text-danger">
                <i class="fa fa-trash mr-1"></i> 移除视频
              </button>
            </div>
          </div>
          
          <div class="pt-4 flex justify-end gap-3">
            <button type="button" id="cancel-article" class="px-6 py-2.5 border border-neutral-300 rounded-lg text-neutral-700 btn-hover">
              取消
            </button>
            <button type="submit" class="px-6 py-2.5 bg-primary text-white rounded-lg btn-hover" id="submit-article-btn">
              提交审核
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- 提示框 -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-neutral-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 opacity-0 translate-y-4">
      <span id="toast-message">提示信息</span>
    </div>
  </div>

  <script>
    // 数据持久化工具 - 增强版确保跨设备数据同步
    const storageUtils = {
      // 保存数据到localStorage，添加错误处理
      saveData(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
          return true;
        } catch (e) {
          console.error('保存数据失败:', e);
          return false;
        }
      },
      
      // 从localStorage加载数据，确保获取最新数据
      loadData(key) {
        try {
          // 强制刷新localStorage
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error('加载数据失败:', e);
          return null;
        }
      },
      
      // 初始化应用数据，确保每次加载都是最新的
      initAppData() {
        // 每次初始化都从localStorage读取最新数据
        const savedData = this.loadData('classWebsiteData');
        if (savedData) {
          return savedData;
        }
        
        // 初始数据结构
        return {
          nextSubAccountId: 1,
          subAccounts: [],
          articles: [],
          notifications: [],
          stats: {
            labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
            data: [0, 0, 0, 0, 0, 0]
          }
        };
      },
      
      // 保存应用数据，确保每次操作都立即保存
      saveAppData(data) {
        return this.saveData('classWebsiteData', data);
      },
      
      // 强制刷新数据
      refreshData() {
        const latestData = this.loadData('classWebsiteData');
        if (latestData) {
          Object.assign(appData, latestData);
          return true;
        }
        return false;
      }
    };

    // 全局数据 - 确保始终是最新的
    let appData = storageUtils.initAppData();
    let currentUser = null;

    // DOM元素
    const elements = {
      pages: {
        login: document.getElementById('login-page'),
        register: document.getElementById('register-page'),
        mainAccount: document.getElementById('main-account-page'),
        subAccount: document.getElementById('sub-account-page')
      },
      loginForm: document.getElementById('login-form'),
      registerForm: document.getElementById('register-form'),
      articleForm: document.getElementById('article-form'),
      articleModal: document.getElementById('article-modal'),
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toast-message'),
      subAccountId: document.getElementById('sub-account-id'),
      registeredCount: document.getElementById('registered-count'),
      pendingCount: document.getElementById('pending-count'),
      publishedCount: document.getElementById('published-count'),
      pendingBadge: document.getElementById('pending-badge'),
      publishedBadge: document.getElementById('published-badge'),
      subPublishedBadge: document.getElementById('sub-published-badge'),
      subaccountsTable: document.getElementById('subaccounts-table'),
      pendingArticles: document.getElementById('pending-articles'),
      myArticles: document.getElementById('my-articles'),
      allPublishedArticles: document.getElementById('all-published-articles'),
      subPublishedArticles: document.getElementById('sub-published-articles'),
      imagePreview: document.getElementById('image-preview'),
      videoPreview: document.getElementById('video-preview'),
      previewVideo: document.getElementById('preview-video'),
      modalTitle: document.getElementById('modal-title'),
      submitArticleBtn: document.getElementById('submit-article-btn'),
      notificationBtn: document.getElementById('notification-btn'),
      notificationPanel: document.getElementById('notification-panel'),
      notificationList: document.getElementById('notification-list'),
      notificationDot: document.getElementById('notification-dot')
    };

    // 工具函数
    const utils = {
      // 显示提示框
      showToast(message, duration = 3000) {
        elements.toastMessage.textContent = message;
        elements.toast.classList.remove('opacity-0', 'translate-y-4');
        elements.toast.classList.add('opacity-100', 'translate-y-0');
        
        setTimeout(() => {
          elements.toast.classList.remove('opacity-100', 'translate-y-0');
          elements.toast.classList.add('opacity-0', 'translate-y-4');
        }, duration);
      },
      
      // 切换页面
      showPage(pageName) {
        Object.keys(elements.pages).forEach(key => {
          elements.pages[key].classList.add('hidden');
        });
        elements.pages[pageName].classList.remove('hidden');
      },
      
      // 格式化日期
      formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      },
      
      // 生成随机ID
      generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      },
      
      // 保存所有数据并刷新
      saveAllData() {
        if (storageUtils.saveAppData(appData)) {
          // 保存后立即刷新数据以确保一致性
          storageUtils.refreshData();
          return true;
        }
        return false;
      },
      
      // 添加通知
      addNotification(message) {
        const notification = {
          id: this.generateId(),
          message: message,
          time: new Date().toISOString(),
          read: false
        };
        
        appData.notifications.push(notification);
        this.saveAllData();
        this.renderNotifications();
      },
      
      // 渲染通知
      renderNotifications() {
        const unreadNotifications = appData.notifications.filter(n => !n.read);
        const notificationDot = elements.notificationDot;
        
        // 更新通知点
        if (unreadNotifications.length > 0) {
          notificationDot.textContent = unreadNotifications.length;
          notificationDot.classList.remove('hidden');
        } else {
          notificationDot.classList.add('hidden');
        }
        
        // 更新通知列表
        if (appData.notifications.length === 0) {
          elements.notificationList.innerHTML = `
            <div class="text-center text-neutral-400 py-4 text-sm">
              暂无通知
            </div>
          `;
          return;
        }
        
        // 按时间排序，最新的在前
        const sortedNotifications = [...appData.notifications].sort((a, b) => 
          new Date(b.time) - new Date(a.time)
        );
        
        let html = '';
        sortedNotifications.forEach(notification => {
          html += `
            <div class="p-2 border-b border-neutral-100 ${!notification.read ? 'bg-primary/5' : ''}">
              <p class="text-sm ${!notification.read ? 'font-medium' : ''}">${notification.message}</p>
              <p class="text-xs text-neutral-400 mt-1">${this.formatDate(notification.time)}</p>
            </div>
          `;
        });
        
        elements.notificationList.innerHTML = html;
      },
      
      // 标记所有通知为已读
      markAllNotificationsAsRead() {
        appData.notifications.forEach(n => n.read = true);
        this.saveAllData();
        this.renderNotifications();
      },
      
      // 强制刷新所有视图
      refreshAllViews() {
        // 从存储重新加载最新数据
        storageUtils.refreshData();
        
        // 刷新所有视图
        if (currentUser && currentUser.role === 'main') {
          renderSubaccounts();
          renderPendingArticles();
        }
        
        if (currentUser) {
          renderMyArticles();
        }
        
        renderAllPublishedArticles();
        updateStats();
        utils.renderNotifications();
      }
    };

    // 初始化图表
    let statsChart;
    function initChart() {
      const ctx = document.getElementById('stats-chart').getContext('2d');
      statsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: appData.stats.labels,
          datasets: [{
            label: '已发布文章',
            data: appData.stats.data,
            borderColor: '#165DFF',
            backgroundColor: 'rgba(22, 93, 255, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    // 更新统计数据
    function updateStats() {
      // 更新计数
      elements.registeredCount.textContent = appData.subAccounts.length;
      
      const pendingArticles = appData.articles.filter(article => article.status === 'pending');
      elements.pendingCount.textContent = pendingArticles.length;
      elements.pendingBadge.textContent = pendingArticles.length;
      
      const publishedArticles = appData.articles.filter(article => article.status === 'published');
      elements.publishedCount.textContent = publishedArticles.length;
      elements.publishedBadge.textContent = publishedArticles.length;
      elements.subPublishedBadge.textContent = publishedArticles.length;
      
      // 更新图表
      if (statsChart) {
        statsChart.data.datasets[0].data = appData.stats.data;
        statsChart.update();
      }
    }

    // 渲染次账号列表
    function renderSubaccounts() {
      // 确保使用最新数据
      storageUtils.refreshData();
      
      if (appData.subAccounts.length === 0) {
        elements.subaccountsTable.innerHTML = `
          <tr>
            <td colspan="5" class="py-8 text-center text-neutral-400">
              暂无注册的次账号
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      appData.subAccounts.forEach(account => {
        const articleCount = appData.articles.filter(article => article.authorId === account.id).length;
        html += `
          <tr class="border-b border-neutral-200">
            <td class="py-3">${account.id}</td>
            <td class="py-3">${utils.formatDate(account.registerTime)}</td>
            <td class="py-3">${articleCount}</td>
            <td class="py-3">
              <span class="bg-success/10 text-success text-xs px-2 py-1 rounded-full">正常</span>
            </td>
            <td class="py-3">
              <button class="text-primary hover:text-primary/80 text-sm view-articles-btn" data-id="${account.id}">
                查看文章
              </button>
            </td>
          </tr>
        `;
      });
      
      elements.subaccountsTable.innerHTML = html;
      
      // 添加查看文章事件
      document.querySelectorAll('.view-articles-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const accountId = btn.getAttribute('data-id');
          const articles = appData.articles.filter(article => article.authorId === accountId);
          utils.showToast(`查看账号 ${accountId} 的文章，共 ${articles.length} 篇`);
        });
      });
    }

    // 渲染待审核文章
    function renderPendingArticles() {
      // 确保使用最新数据
      storageUtils.refreshData();
      
      const pendingArticles = appData.articles.filter(article => article.status === 'pending');
      
      if (pendingArticles.length === 0) {
        elements.pendingArticles.innerHTML = `
          <div class="text-center text-neutral-400 py-8">
            暂无待审核文章
          </div>
        `;
        return;
      }
      
      let html = '';
      pendingArticles.forEach(article => {
        const author = appData.subAccounts.find(acc => acc.id === article.authorId);
        html += `
          <div class="border border-neutral-200 rounded-xl p-4 hover:border-primary/50 transition-colors">
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-medium">${article.title}</h4>
              <span class="text-xs bg-warning/10 text-warning px-2 py-0.5 rounded-full">待审核</span>
            </div>
            <p class="text-sm text-neutral-600 mb-3 line-clamp-2">${article.content}</p>
            <div class="flex justify-between items-center text-xs text-neutral-500 mb-3">
              <span>作者: ${author ? author.id : '未知'}</span>
              <span>发布时间: ${utils.formatDate(article.publishTime)}</span>
            </div>
            ${article.images.length > 0 ? `
              <div class="flex gap-2 mb-3 overflow-x-auto pb-2">
                ${article.images.map(img => `
                  <img src="${img}" alt="文章图片" class="w-16 h-16 object-cover rounded">
                `).join('')}
              </div>
            ` : ''}
            ${article.video ? `
              <div class="mb-3">
                <video src="${article.video}" controls class="w-full max-h-40 object-contain rounded"></video>
              </div>
            ` : ''}
            <div class="flex justify-end gap-2">
              <button class="reject-article-btn px-3 py-1 text-xs bg-neutral-200 text-neutral-700 rounded-lg" data-id="${article.id}">
                驳回
              </button>
              <button class="approve-article-btn px-3 py-1 text-xs bg-success text-white rounded-lg" data-id="${article.id}">
                通过
              </button>
            </div>
          </div>
        `;
      });
      
      elements.pendingArticles.innerHTML = html;
      
      // 添加审核事件
      document.querySelectorAll('.approve-article-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const articleId = btn.getAttribute('data-id');
          const article = appData.articles.find(a => a.id === articleId);
          if (article) {
            article.status = 'published';
            
            // 发送通知给文章作者
            const author = appData.subAccounts.find(acc => acc.id === article.authorId);
            if (author) {
              utils.addNotification(`您的文章《${article.title}》已通过审核`);
            }
            
            // 更新界面
            renderPendingArticles();
            renderMyArticles();
            renderAllPublishedArticles();
            
            // 更新图表数据
            const month = new Date().getMonth();
            appData.stats.data[month]++;
            
            updateStats();
            utils.saveAllData();
            utils.showToast('文章已通过审核');
          }
        });
      });
      
      document.querySelectorAll('.reject-article-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const articleId = btn.getAttribute('data-id');
          const article = appData.articles.find(a => a.id === articleId);
          if (article) {
            article.status = 'rejected';
            
            // 发送通知给文章作者
            const author = appData.subAccounts.find(acc => acc.id === article.authorId);
            if (author) {
              utils.addNotification(`您的文章《${article.title}》未通过审核`);
            }
            
            // 更新界面
            renderPendingArticles();
            renderMyArticles();
            updateStats();
            utils.saveAllData();
            utils.showToast('文章已驳回');
          }
        });
      });
    }

    // 渲染我的文章（包括主账号和次账号）
    function renderMyArticles() {
      if (!currentUser) return;
      
      // 确保使用最新数据
      storageUtils.refreshData();
      
      // 筛选当前用户的文章
      const myArticles = appData.articles.filter(article => article.authorId === currentUser.id);
      
      if (myArticles.length === 0) {
        elements.myArticles.innerHTML = `
          <div class="text-center text-neutral-400 py-8">
            您尚未发布任何文章
          </div>
        `;
        return;
      }
      
      let html = '';
      myArticles.forEach(article => {
        let statusBadge = '';
        switch (article.status) {
          case 'pending':
            statusBadge = '<span class="bg-warning/10 text-warning text-xs px-2 py-0.5 rounded-full">待审核</span>';
            break;
          case 'published':
            statusBadge = '<span class="bg-success/10 text-success text-xs px-2 py-0.5 rounded-full">已发布</span>';
            break;
          case 'rejected':
            statusBadge = '<span class="bg-danger/10 text-danger text-xs px-2 py-0.5 rounded-full">已驳回</span>';
            break;
        }
        
        html += `
          <div class="border border-neutral-200 rounded-xl p-4 hover:border-primary/50 transition-colors">
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-medium">${article.title}</h4>
              ${statusBadge}
            </div>
            <p class="text-sm text-neutral-600 mb-3 line-clamp-2">${article.content}</p>
            <div class="flex justify-between items-center text-xs text-neutral-500 mb-3">
              <span>发布时间: ${utils.formatDate(article.publishTime)}</span>
            </div>
            ${article.images.length > 0 ? `
              <div class="flex gap-2 mb-3 overflow-x-auto pb-2">
                ${article.images.map(img => `
                  <img src="${img}" alt="文章图片" class="w-16 h-16 object-cover rounded">
                `).join('')}
              </div>
            ` : ''}
            ${article.video ? `
              <div class="mb-3">
                <video src="${article.video}" controls class="w-full max-h-40 object-contain rounded"></video>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      elements.myArticles.innerHTML = html;
    }

    // 渲染所有已发布文章（供所有账号查看）
    function renderAllPublishedArticles() {
      // 确保使用最新数据
      storageUtils.refreshData();
      
      const publishedArticles = appData.articles.filter(article => article.status === 'published');
      
      // 更新主账号页面的已发布文章列表
      if (publishedArticles.length === 0) {
        elements.allPublishedArticles.innerHTML = `
          <div class="text-center text-neutral-400 py-8">
            暂无已发布文章
          </div>
        `;
      } else {
        let html = '';
        publishedArticles.forEach(article => {
          const author = appData.subAccounts.find(acc => acc.id === article.authorId) || 
                         (article.authorId === 'chenkai_wangzhan' ? {id: '主账号'} : null);
          html += `
            <div class="border border-neutral-200 rounded-xl p-4 hover:border-primary/50 transition-colors">
              <div class="flex justify-between items-start mb-2">
                <h4 class="font-medium">${article.title}</h4>
                <span class="bg-success/10 text-success text-xs px-2 py-0.5 rounded-full">已发布</span>
              </div>
              <p class="text-sm text-neutral-600 mb-3 line-clamp-2">${article.content}</p>
              <div class="flex justify-between items-center text-xs text-neutral-500 mb-3">
                <span>作者: ${author ? author.id : '未知'}</span>
                <span>发布时间: ${utils.formatDate(article.publishTime)}</span>
              </div>
              ${article.images.length > 0 ? `
                <div class="flex gap-2 mb-3 overflow-x-auto pb-2">
                  ${article.images.map(img => `
                    <img src="${img}" alt="文章图片" class="w-16 h-16 object-cover rounded">
                  `).join('')}
                </div>
              ` : ''}
              ${article.video ? `
                <div class="mb-3">
                  <video src="${article.video}" controls class="w-full max-h-40 object-contain rounded"></video>
                </div>
              ` : ''}
            </div>
          `;
        });
        elements.allPublishedArticles.innerHTML = html;
      }
      
      // 更新次账号页面的已发布文章列表
      elements.subPublishedArticles.innerHTML = elements.allPublishedArticles.innerHTML;
    }

    // 打开文章发布窗口
    function openArticleModal(isMainAccount = false) {
      elements.articleModal.classList.remove('hidden');
      
      // 根据用户类型调整弹窗标题和按钮文本
      if (isMainAccount) {
        elements.modalTitle.textContent = '主账号发布文章';
        elements.submitArticleBtn.textContent = '直接发布';
      } else {
        elements.modalTitle.textContent = '发布文章';
        elements.submitArticleBtn.textContent = '提交审核';
      }
      
      // 设置默认时间为当前时间
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('article-time').value = now.toISOString().slice(0, 16);
      
      // 清空预览
      elements.imagePreview.innerHTML = '';
      elements.videoPreview.classList.add('hidden');
      elements.previewVideo.src = '';
      elements.articleForm.reset();
    }

    // 事件监听
    function setupEventListeners() {
      // 登录表单提交
      elements.loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // 刷新数据确保获取最新账号信息
        storageUtils.refreshData();
        
        // 主账号登录
        if (username === 'chenkai_wangzhan' && password === 'chenkai2025') {
          currentUser = {
            id: username,
            role: 'main'
          };
          utils.showPage('mainAccount');
          utils.refreshAllViews(); // 登录后刷新所有视图
          utils.showToast('主账号登录成功');
        } 
        // 次账号登录
        else {
          const accountId = username;
          const account = appData.subAccounts.find(acc => acc.id === accountId && acc.password === password);
          
          if (account) {
            currentUser = {
              id: accountId,
              role: 'sub'
            };
            elements.subAccountId.textContent = `账号: ${accountId}`;
            utils.showPage('subAccount');
            utils.refreshAllViews(); // 登录后刷新所有视图
            utils.showToast(`次账号 ${accountId} 登录成功`);
          } else {
            utils.showToast('账号或密码错误');
          }
        }
        
        elements.loginForm.reset();
      });
      
      // 注册表单提交
      elements.registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('reg-password').value;
        const confirm = document.getElementById('reg-confirm').value;
        
        if (password !== confirm) {
          utils.showToast('两次输入的密码不一致');
          return;
        }
        
        if (password.length < 6) {
          utils.showToast('密码长度不能少于6位');
          return;
        }
        
        // 刷新数据确保获取最新的账号ID
        storageUtils.refreshData();
        
        // 分配账号ID
        const accountId = appData.nextSubAccountId.toString();
        appData.nextSubAccountId++;
        
        // 创建新账号
        appData.subAccounts.push({
          id: accountId,
          password: password,
          registerTime: new Date().toISOString()
        });
        
        // 保存数据并刷新
        if (utils.saveAllData()) {
          // 发送新账号注册通知给主账号
          utils.addNotification(`新次账号 ${accountId} 已注册`);
          
          // 显示两次提示
          utils.showToast(`注册成功！您的账号是: ${accountId}`, 2000);
          setTimeout(() => {
            utils.showToast(`请记住您的账号: ${accountId} 和密码`, 3000);
          }, 2100);
          
          // 重置表单并返回登录页
          elements.registerForm.reset();
          setTimeout(() => {
            utils.showPage('login');
          }, 5000);
          
          // 更新统计
          updateStats();
        } else {
          utils.showToast('注册失败，请重试');
        }
      });
      
      // 显示注册页面
      document.getElementById('show-register').addEventListener('click', (e) => {
        e.preventDefault();
        utils.showPage('register');
      });
      
      // 返回登录页面
      document.getElementById('back-to-login').addEventListener('click', () => {
        utils.showPage('login');
      });
      
      // 主账号登出
      document.getElementById('main-logout').addEventListener('click', () => {
        if (confirm('确定要退出主账号吗？')) {
          currentUser = null;
          utils.showPage('login');
          utils.showToast('已退出主账号');
        }
      });
      
      // 次账号登出
      document.getElementById('sub-logout').addEventListener('click', () => {
        if (confirm('确定要退出吗？')) {
          currentUser = null;
          utils.showPage('login');
          utils.showToast('已退出登录');
        }
      });
      
      // 主账号发布新文章
      document.getElementById('main-new-article-btn').addEventListener('click', () => {
        openArticleModal(true); // 标记为主账号发布
      });
      
      // 次账号发布新文章
      document.getElementById('new-article-btn').addEventListener('click', () => {
        openArticleModal(false); // 标记为次账号发布
      });
      
      // 关闭文章弹窗
      document.getElementById('close-modal').addEventListener('click', () => {
        elements.articleModal.classList.add('hidden');
      });
      
      // 取消发布文章
      document.getElementById('cancel-article').addEventListener('click', () => {
        elements.articleModal.classList.add('hidden');
      });
      
      // 文章表单提交
      elements.articleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        if (!currentUser) {
          utils.showToast('请先登录');
          return;
        }
        
        const title = document.getElementById('article-title').value;
        const content = document.getElementById('article-content').value;
        const publishTime = document.getElementById('article-time').value;
        
        if (!title || !content || !publishTime) {
          utils.showToast('请填写完整信息');
          return;
        }
        
        // 创建文章对象
        const newArticle = {
          id: utils.generateId(),
          authorId: currentUser.id,
          title: title,
          content: content,
          publishTime: publishTime,
          // 主账号发布的文章直接通过，次账号需要审核
          status: currentUser.role === 'main' ? 'published' : 'pending',
          images: [],
          video: null,
          createTime: new Date().toISOString()
        };
        
        // 收集图片
        const imagePreviews = elements.imagePreview.querySelectorAll('img');
        imagePreviews.forEach(img => {
          newArticle.images.push(img.src);
        });
        
        // 收集视频
        if (elements.previewVideo.src) {
          newArticle.video = elements.previewVideo.src;
        }
        
        // 添加到文章列表
        appData.articles.push(newArticle);
        
        // 如果是次账号发布，通知主账号
        if (currentUser.role === 'sub') {
          utils.addNotification(`账号 ${currentUser.id} 发布了新文章《${title}》等待审核`);
        } else {
          // 主账号发布的文章更新统计
          const month = new Date().getMonth();
          appData.stats.data[month]++;
        }
        
        // 保存数据并刷新所有视图
        if (utils.saveAllData()) {
          // 更新UI
          elements.articleModal.classList.add('hidden');
          utils.refreshAllViews();
          
          // 根据用户类型显示不同提示
          if (currentUser.role === 'main') {
            utils.showToast('文章已成功发布');
          } else {
            utils.showToast('文章已提交，等待审核');
          }
        } else {
          utils.showToast('发布失败，请重试');
        }
      });
      
      // 图片上传预览
      document.getElementById('image-upload').addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length === 0) return;
        
        // 限制最多5张图片
        if (files.length > 5) {
          utils.showToast('最多只能上传5张图片');
          return;
        }
        
        elements.imagePreview.innerHTML = '';
        
        Array.from(files).forEach(file => {
          if (!file.type.startsWith('image/')) {
            utils.showToast('请上传图片文件');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (event) => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'relative group';
            
            const img = document.createElement('img');
            img.src = event.target.result;
            img.className = 'w-20 h-20 object-cover rounded-lg';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'absolute -top-2 -right-2 bg-danger text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity';
            removeBtn.innerHTML = '<i class="fa fa-times"></i>';
            removeBtn.type = 'button';
            removeBtn.addEventListener('click', () => {
              imgContainer.remove();
            });
            
            imgContainer.appendChild(img);
            imgContainer.appendChild(removeBtn);
            elements.imagePreview.appendChild(imgContainer);
          };
          reader.readAsDataURL(file);
        });
      });
      
      // 视频上传预览
      document.getElementById('video-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('video/')) {
          utils.showToast('请上传视频文件');
          return;
        }
        
        if (file.size > 100 * 1024 * 1024) {
          utils.showToast('视频文件不能超过100MB');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          elements.previewVideo.src = event.target.result;
          elements.videoPreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      });
      
      // 移除视频
      document.getElementById('remove-video').addEventListener('click', () => {
        elements.videoPreview.classList.add('hidden');
        elements.previewVideo.src = '';
        document.getElementById('video-upload').value = '';
      });
      
      // 文章筛选
      document.querySelectorAll('.article-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // 更新按钮样式
          document.querySelectorAll('.article-filter-btn').forEach(b => {
            b.classList.remove('active', 'bg-primary', 'text-white');
            b.classList.add('bg-neutral-200', 'text-neutral-700');
          });
          btn.classList.remove('bg-neutral-200', 'text-neutral-700');
          btn.classList.add('active', 'bg-primary', 'text-white');
          
          // 筛选逻辑
          const filter = btn.textContent.trim();
          const currentId = currentUser.id;
          
          // 确保使用最新数据
          storageUtils.refreshData();
          
          let filteredArticles = [];
          
          switch(filter) {
            case '全部':
              filteredArticles = appData.articles.filter(article => article.authorId === currentId);
              break;
            case '待审核':
              filteredArticles = appData.articles.filter(article => 
                article.authorId === currentId && article.status === 'pending'
              );
              break;
            case '已发布':
              filteredArticles = appData.articles.filter(article => 
                article.authorId === currentId && article.status === 'published'
              );
              break;
            case '已驳回':
              filteredArticles = appData.articles.filter(article => 
                article.authorId === currentId && article.status === 'rejected'
              );
              break;
          }
          
          // 更新显示
          if (filteredArticles.length === 0) {
            elements.myArticles.innerHTML = `
              <div class="text-center text-neutral-400 py-8">
                暂无${filter === '全部' ? '' : filter}文章
              </div>
            `;
          } else {
            let html = '';
            filteredArticles.forEach(article => {
              let statusBadge = '';
              switch (article.status) {
                case 'pending':
                  statusBadge = '<span class="bg-warning/10 text-warning text-xs px-2 py-0.5 rounded-full">待审核</span>';
                  break;
                case 'published':
                  statusBadge = '<span class="bg-success/10 text-success text-xs px-2 py-0.5 rounded-full">已发布</span>';
                  break;
                case 'rejected':
                  statusBadge = '<span class="bg-danger/10 text-danger text-xs px-2 py-0.5 rounded-full">已驳回</span>';
                  break;
              }
              
              html += `
                <div class="border border-neutral-200 rounded-xl p-4 hover:border-primary/50 transition-colors">
                  <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium">${article.title}</h4>
                    ${statusBadge}
                  </div>
                  <p class="text-sm text-neutral-600 mb-3 line-clamp-2">${article.content}</p>
                  <div class="flex justify-between items-center text-xs text-neutral-500 mb-3">
                    <span>发布时间: ${utils.formatDate(article.publishTime)}</span>
                  </div>
                  ${article.images.length > 0 ? `
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-2">
                      ${article.images.map(img => `
                        <img src="${img}" alt="文章图片" class="w-16 h-16 object-cover rounded">
                      `).join('')}
                    </div>
                  ` : ''}
                  ${article.video ? `
                    <div class="mb-3">
                      <video src="${article.video}" controls class="w-full max-h-40 object-contain rounded"></video>
                    </div>
                  ` : ''}
                </div>
              `;
            });
            elements.myArticles.innerHTML = html;
          }
        });
      });
      
      // 通知按钮点击事件
      elements.notificationBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        elements.notificationPanel.classList.toggle('hidden');
        // 点击通知面板时标记所有通知为已读
        utils.markAllNotificationsAsRead();
      });
      
      // 点击页面其他地方关闭通知面板
      document.addEventListener('click', () => {
        elements.notificationPanel.classList.add('hidden');
      });
      
      // 阻止通知面板内部点击事件冒泡
      elements.notificationPanel.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      // 定时刷新数据，确保跨设备同步
      setInterval(() => {
        if (currentUser) {
          utils.refreshAllViews();
        }
      }, 30000); // 每30秒刷新一次
    }

    // 初始化
    function init() {
      // 设置默认页面
      utils.showPage('login');
      
      // 初始化图表
      initChart();
      
      // 设置事件监听
      setupEventListeners();
      
      // 初始化统计
      updateStats();
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
